.PHONY: run build pull fire

MAXRPS=1000
TESTDUR=1200
BATCHSIZE=10
REV=$(shell git rev-parse HEAD)

run: build
	java -Xms16g -Xmx16g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -jar ./target/uber-kload-1.0-SNAPSHOT.jar

build: pull
	mvn clean package

fire: pull
	echo "[phantom]"                                                                              >  autogenerated.ini
	echo "address = edi18:8888"                                                                   >> autogenerated.ini
	echo "rps_schedule = line(1, ${MAXRPS}, 60s) const(${MAXRPS}, ${TESTDUR}s)"                   >> autogenerated.ini
	echo "instances = 10000"                                                                      >> autogenerated.ini
	echo "header_http = 1.1"                                                                      >> autogenerated.ini
	echo "uris = /kload${BATCHSIZE}"                                                              >> autogenerated.ini
	echo "[sapsan]"                                                                               >> autogenerated.ini
	echo "project = Vostok"                                                                       >> autogenerated.ini
	echo "test_title = ${REV}"                                                                    >> autogenerated.ini
	echo "description = line(1, ${MAXRPS}, 60s) const(${MAXRPS}, ${TESTDUR}s) /kload${BATCHSIZE}" >> autogenerated.ini
	yandex-tank -c autogenerated.ini

pull:
	git pull
